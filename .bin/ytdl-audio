#!/usr/bin/env bash

# set -x # Only used for debugging...
set -euo pipefail

# Function to display help message
usage() {
  echo "Usage: $(basename "$0") [OPTIONS] [URL1 URL2 ... | --batch-file FILE | --edit-links]"
  echo ""
  echo "Downloads audio from YouTube playlists or individual videos."
  echo ""
  echo "Options:"
  echo "  -e, --edit-links       Open an editor to paste/write links interactively."
  echo "  -h, --help             Display this help message and exit."
  echo ""
  echo "Arguments:"
  echo "  URL1 URL2 ...          One or more direct URLs to download."
  echo "  --batch-file FILE      Specify a file containing a list of URLs, one per line."
  echo ""
  echo "Examples:"
  echo "  $(basename "$0") https://www.youtube.com/playlist?list=..."
  echo "  $(basename "$0") --batch-file links.txt"
  echo "  $(basename "$0") -e"
  echo ""
  echo "Environment Variables:"
  echo "  BROWSER                The browser to use for cookies (default: firefox)."
  echo "  EDITOR                 The editor to use for --edit-links (default: vim)."
}

main()  {
  local urls_file=""
  local use_editor=false

  # Parse options
  while [[ "$#" -gt 0 ]]; do
    case "$1" in
      -h|--help)
        usage
        exit 0
        ;;
      -e|--edit-links)
        use_editor=true
        shift # Remove the flag from arguments
        ;;
      --batch-file)
        if [[ -n "$2" && -f "$2" ]]; then
          urls_file="$2"
          shift 2 # Remove --batch-file and the filename
        else
          echo "Error: --batch-file requires a valid file path." >&2
          usage
          exit 1
        fi
        ;;
      *)
        # If it's not an option, assume it's a URL or the start of URLs
        # We'll handle this in the main logic if no batch file or editor is used
        break
        ;;
    esac
  done

  # If --edit-links was used, open the editor
  if [[ "$use_editor" = true ]]; then
    # Create a temporary file
    urls_file=$(mktemp)
    # Open the editor
    "${EDITOR:-vim}" "$urls_file" # Use $EDITOR, fallback to vim
    # Check if the file has content after editing
    if [[ ! -s "$urls_file" ]]; then
      echo "No links provided. Exiting."
      rm "$urls_file" # Clean up temporary file
      exit 1
    fi
  fi

  # Construct the yt-dlp command
  local yt_dlp_cmd=(
    yt-dlp
    --extract-audio
    --audio-format mp3
    --embed-thumbnail
    --embed-metadata
    --no-mtime
    --no-embed-chapters
    --no-embed-info-json
    --cookies-from-browser  "${BROWSER:-firefox}"
    --output "%(playlist_title)s/%(title)s.%(ext)s"
  )

  # Add the batch file argument if we have one
  if [[ -n "$urls_file" ]]; then
    yt_dlp_cmd+=(--batch-file "$urls_file")
  fi

  # Add any remaining arguments (which would be direct URLs if not using batch file or editor)
  yt_dlp_cmd+=("$@")

  # Execute the command
  "${yt_dlp_cmd[@]}"

  # Clean up the temporary file if it was created
  if [[ "$use_editor" = true ]]; then
    rm "$urls_file"
  fi
}

main "$@"

# vim:sw=2:ts=2:et:
