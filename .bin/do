#!/usr/bin/env bash

# set -x # WARN: Only for debugging...
set -euo pipefail

UFLAGS=${UFLAGS-""}
CFLAGS=${CFLAGS-"-Wall -Wextra -Wpedantic -Werror -std=c99 -Os -g -ggdb"}

CC=${CC:-gcc}
CXX=${CXX:-g++}

KEEP_EXECUTABLE=0
FORCE_OVERWRITE=0
CLEAN_ONLY=0
OUT_NAME=""
PROG_ARGS=()

build() {
  case "$1" in
    *.c)
      # shellcheck disable=SC2086
      "$CC" -o "$2" "$1" $CFLAGS $UFLAGS
      ;;
    *.cpp | *.cc | *.cxx)
      # shellcheck disable=SC2086
      "$CXX" -o "$2" "$1" $CFLAGS $UFLAGS
      ;;
    *)
      echo >&2 "O.o"
      return 1
      ;;
  esac
}

usage() {
  cat >&2 <<EOF
  usage: $(basename "$0") [options] <source> [-- program args...]

options:
  -k, --keep        keep executable
  -o <name>         output executable name
  -f                overwrite existing executable
  --clean           remove executable and exit

env:
  CC, CXX           override C / C++ compiler
EOF
  exit 1
}

needs_rebuild() {
  [[ ! -f $2 || $1 -nt $2 ]]
}

normalize_out_name() {
  case "$1" in
    */* | ./*) printf '%s\n' "$1" ;;
    *)         printf './%s\n' "$1" ;;
  esac
}

infer_executable() {
  local src=$1
  local base name

  base=$(basename "$src")
  name=${base%.*}

  if [[ -n $OUT_NAME ]]; then
    normalize_out_name "$OUT_NAME"
  else
    printf './%s\n' "$name"
  fi
}

main() {
  while (($#)); do
    case "$1" in
      --)
        shift
        PROG_ARGS=("$@")
        break
        ;;
      --clean)
        CLEAN_ONLY=1
        shift
        ;;
      -k | --keep)
        KEEP_EXECUTABLE=1
        shift
        ;;
      -f)
        FORCE_OVERWRITE=1
        shift
        ;;
      -o)
        [[ $# -ge 2 ]] || usage
        OUT_NAME=$2
        shift 2
        ;;
      -*)
        usage
        ;;
      *)
        break
        ;;
    esac
  done

  [[ $# -ge 1 ]] || usage

  src=$(realpath "$1" 2>/dev/null || readlink -f "$1")
  [[ -f $src ]] || {
    echo >&2 "O.o"
    exit 1
  }

  executable=$(infer_executable "$src")

  if [[ -e $executable && $FORCE_OVERWRITE -eq 0 ]]; then
    :
  fi

  if ((CLEAN_ONLY)); then
    if [[ -e $executable ]]; then
      rm -f "$executable"
      exit 0
    else
      echo >&2 "O.o"
      exit 1
    fi
  fi

  if [[ -e $executable && $FORCE_OVERWRITE -eq 0 ]]; then
    if needs_rebuild "$src" "$executable"; then
      echo >&2 "O.o"
      exit 1
    fi
  fi

  if needs_rebuild "$src" "$executable"; then
    build "$src" "$executable"
    chmod +x "$executable"
  fi

  "$executable" "${PROG_ARGS[@]}"

  ((KEEP_EXECUTABLE)) || rm -f "$executable"
}

main "$@"

# vim:ft=bash:ts=2:sw=2:et:
