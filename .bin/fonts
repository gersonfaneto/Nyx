#!/usr/bin/env bash

# set -x # WARN: Only used for debugging...
set -euo pipefail

CONFIGURATIONS="${XDG_CONFIG_HOME:-$HOME/.config}"

STATES="${XDG_STATE_HOME:-$HOME/.local/state}"

DEFAULT_FONT="Departure Mono"

FONT_STATE=$(cat "$STATES/fonts.txt" 2> /dev/null || exit 0)

FONT_IN_USE="${FONT_STATE:-$DEFAULT_FONT}"

FONTS_IGNORED=(
  'Mono$'
  'Propo$'
  '^DejaVu'
  '^Fixed$'
  '^Free'
  '^Grape'
  '^Liberation*'
  '^Noto'
  '^Rec Mono*'
  '^Recursive'
  '^Symbols'
  '^TeX'
  '^Unifont$'
  '^feather$'
  'cursor\.pcf'
)

FONTS_AVAILABLE=()
while IFS= read -r font; do
  FONTS_AVAILABLE+=("$font")
done < <(ghostty +list-fonts | grep -v '^[[:blank:]]' | grep -v '^$' | sort | uniq)

FONTS_FILTERED=()
for font in "${FONTS_AVAILABLE[@]}"; do
  skip=false
  for pat in "${FONTS_IGNORED[@]}"; do
    if [[ "$font" =~ $pat ]]; then
      skip=true
      break
    fi
  done
  if [ "$skip" = false ]; then
    FONTS_FILTERED+=("$font")
  fi
done
FONTS_AVAILABLE=("${FONTS_FILTERED[@]}")

switch_alacritty() {
  (
    ALACRITTY_CONFIGURATION="$CONFIGURATIONS/alacritty/local.toml"

    if [ ! -f "$ALACRITTY_CONFIGURATION" ]; then
      echo "[font.normal]" > "$ALACRITTY_CONFIGURATION"
      echo "family = '$FONT'" >> "$ALACRITTY_CONFIGURATION"
    else
      sed -i "s|^\([[:space:]]*\)family = .*|\1family = '$FONT'|" "$ALACRITTY_CONFIGURATION"
    fi

    touch "$CONFIGURATIONS/alacritty/alacritty.toml"
  )
}

switch_ghostty() {
  (
    GHOSTTY_CONFIGURATION="$CONFIGURATIONS/ghostty/config.local"

    if [ ! -f "$GHOSTTY_CONFIGURATION" ]; then
      echo "font-family = \"$FONT\"" > "$GHOSTTY_CONFIGURATION"
    else
      sed -i "s|^font-family = .*|font-family = \"$FONT\"|" "$GHOSTTY_CONFIGURATION"
    fi

    kill -USR2 "$(pgrep ghostty)"
  )
}

switch_emacs() {
  (
    EMACS_CONFIG="$HOME/.emacs.d/local.el"

    NEW_FONT="$FONT 10"

    if [ ! -f "$EMACS_CONFIG" ]; then
      echo "(setq minimal/default-font \"$NEW_FONT\")" > "$EMACS_CONFIG"
    else
      CURRENT_EMACS_FONT=$(grep 'setq minimal/default-font' "$EMACS_CONFIG" | sed 's@(setq minimal/default-font "\(.*\)")@\1@')
      if [ -n "$CURRENT_EMACS_FONT" ]; then
        SIZE=$(echo "$CURRENT_EMACS_FONT" | awk '{print $NF}')
        NEW_FONT="$FONT $SIZE"
        sed -i "s@(setq minimal/default-font \".*\")@(setq minimal/default-font \"$NEW_FONT\")@" "$EMACS_CONFIG"
      fi
    fi

    if command -v emacsclient > /dev/null 2>&1; then
      emacsclient -e "(progn (setq minimal/default-font \"$NEW_FONT\") (dolist (frame (frame-list)) (set-frame-font minimal/default-font nil t frame)))" > /dev/null 2>&1 || true
    fi
  )
}

usage() {
  local program
  program=$(basename "$0")
  echo "Usage: $program <font_name>"
  echo
  echo "       -h,--help    Display this message"
  echo "       -l,--list    List all the available fonts"
}

list_fonts() {
  for font in "${FONTS_AVAILABLE[@]}"; do
    if [ "$font" = "$FONT_IN_USE" ]; then
      printf "\033[4m%s\033[0m (current)\n" "$font"
    else
      printf "%s\n" "$font"
    fi
  done
}

main() {
  while [ $# -gt 0 ]; do
    case $1 in
      -h | --help)
        usage
        exit 0
        ;;
      -l | --list)
        list_fonts
        exit 0
        ;;
      -*)
        echo "Unknown option: $1" >&2
        echo
        usage >&2
        exit 1
        ;;
      *)
        break
        ;;
    esac
    shift
  done

  if [ $# -ne 1 ]; then
    usage "$@"
    exit 0
  fi

  FONT="$1"

  VALID=false

  for avail in "${FONTS_AVAILABLE[@]}"; do
    if [ "$FONT" = "$avail" ]; then
      VALID=true
      break
    fi
  done

  if [ "$VALID" = false ]; then
    echo "Unknown font: $1" >&2
    echo
    usage "$@"
    exit 1
  fi

  if [ "$FONT" = "$FONT_IN_USE" ]; then
    echo "I can't handle change O.o"
    exit 0
  fi

  (
    cat /dev/null > $STATES/fonts.txt
    echo "$FONT" >> $STATES/fonts.txt
  )

  switch_alacritty
  switch_ghostty
  switch_emacs

  printf "Switched to \033[4m%s\033[0m\n" "$FONT"
}

main "$@"

# vim:ft=bash:ts=2:sw=2:et:
